<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konservieren - Artefakt Analyse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .api-key-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .api-key-section.hidden {
            display: none;
        }

        .api-key-section h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .api-key-section p {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .api-key-section a {
            color: #667eea;
            text-decoration: none;
        }

        .api-key-section a:hover {
            text-decoration: underline;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 30px 40px;
            border: none;
            border-radius: 15px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 100px;
            display: inline-block;
            line-height: 1.4;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            min-height: auto;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .usage-section {
            margin-bottom: 30px;
        }

        .usage-section.hidden {
            display: none;
        }

        .usage-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .usage-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .usage-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
        }

        .usage-option:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .usage-option.selected {
            border-color: #667eea;
            background: #e7edff;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-section.hidden {
            display: none;
        }

        .upload-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .image-slot {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            position: relative;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .image-slot.has-image {
            border-style: solid;
            border-color: #667eea;
            background: white;
        }

        .image-preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
        }

        .image-preview-small {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 5px;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .remove-image:hover {
            background: #c82333;
        }

        .image-context {
            margin-top: 10px;
        }

        .image-context textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .image-context textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-context label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .upload-btn-small {
            padding: 10px 20px;
            font-size: 14px;
            min-height: auto;
        }

        .upload-btn {
            position: relative;
            overflow: hidden;
        }

        .upload-btn input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .analyze-btn {
            width: 100%;
            background: #28a745;
            color: white;
            padding: 15px;
            font-size: 18px;
            min-height: auto;
        }

        .analyze-btn:hover {
            background: #218838;
        }

        .analyze-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            margin-bottom: 30px;
        }

        .result-section.hidden {
            display: none;
        }

        .result-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
            white-space: pre-wrap;
            line-height: 1.8;
            color: #333;
            max-height: 600px;
            overflow-y: auto;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .error.hidden {
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            color: #6c757d;
            font-size: 14px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .usage-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Konservieren</h1>
        <div class="subtitle">Artefakt-Analyse f√ºr Museum & Archiv</div>

        <!-- API Key Eingabe -->
        <div id="apiKeySection" class="api-key-section">
            <h3>üîë Google Gemini API Key eingeben</h3>
            <p>
                Du ben√∂tigst einen Google Gemini API Key (kostenlos!).<br>
                Hole dir deinen Key auf <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.<br>
                Kostenlos: 15 Anfragen pro Minute, 1500 pro Tag.
            </p>
            <div class="api-input-group">
                <input type="password" id="apiKeyInput" placeholder="AIzaSy..." />
                <button class="btn btn-primary" onclick="saveApiKey()">Speichern</button>
            </div>
        </div>

        <!-- Fehleranzeige -->
        <div id="errorSection" class="error hidden"></div>

        <!-- Verwendungszweck -->
        <div id="usageSection" class="usage-section hidden">
            <h3>üìã Verwendungszweck des Artefakts</h3>
            <div class="usage-options">
                <div class="usage-option" onclick="selectUsage('exhibition')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üñºÔ∏è</div>
                    <strong>Dauerausstellung</strong>
                </div>
                <div class="usage-option" onclick="selectUsage('temporary')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üé®</div>
                    <strong>Wechselausstellung</strong>
                </div>
                <div class="usage-option" onclick="selectUsage('storage')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üì¶</div>
                    <strong>Langzeitlagerung</strong>
                </div>
                <div class="usage-option" onclick="selectUsage('transport')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üöö</div>
                    <strong>Transport</strong>
                </div>
            </div>
        </div>

        <!-- Upload Bereich -->
        <div id="uploadSection" class="upload-section hidden">
            <h3>üì∏ Artefakt dokumentieren (bis zu 4 Bilder)</h3>
            <p style="color: #6c757d; font-size: 14px; margin-bottom: 15px;">
                F√ºge mehrere Bilder hinzu (Gesamtansicht, Details, Sch√§den, etc.) und beschreibe jedes Bild mit Kontext-Informationen.
            </p>

            <div class="images-grid" id="imagesGrid">
                <div class="image-slot" id="slot1">
                    <div class="image-preview-container" id="preview1"></div>
                    <div class="upload-btn">
                        <label for="imageInput1" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 1 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput1" accept="image/*" capture="environment" onchange="handleImageUpload(1, event)">
                    </div>
                    <div class="image-context" id="context1" style="display: none;">
                        <label>Kontext-Information zu Bild 1:</label>
                        <textarea id="contextText1" placeholder="z.B. Gesamtansicht, lagert seit 10 Jahren bei 60% Luftfeuchtigkeit, Temperatur 18¬∞C..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot2">
                    <div class="image-preview-container" id="preview2"></div>
                    <div class="upload-btn">
                        <label for="imageInput2" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 2 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput2" accept="image/*" capture="environment" onchange="handleImageUpload(2, event)">
                    </div>
                    <div class="image-context" id="context2" style="display: none;">
                        <label>Kontext-Information zu Bild 2:</label>
                        <textarea id="contextText2" placeholder="z.B. Detailaufnahme eines Schadens, Verf√§rbung, Riss..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot3">
                    <div class="image-preview-container" id="preview3"></div>
                    <div class="upload-btn">
                        <label for="imageInput3" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 3 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput3" accept="image/*" capture="environment" onchange="handleImageUpload(3, event)">
                    </div>
                    <div class="image-context" id="context3" style="display: none;">
                        <label>Kontext-Information zu Bild 3:</label>
                        <textarea id="contextText3" placeholder="z.B. R√ºckseite, Unterseite, Materialdetails..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot4">
                    <div class="image-preview-container" id="preview4"></div>
                    <div class="upload-btn">
                        <label for="imageInput4" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 4 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput4" accept="image/*" capture="environment" onchange="handleImageUpload(4, event)">
                    </div>
                    <div class="image-context" id="context4" style="display: none;">
                        <label>Kontext-Information zu Bild 4:</label>
                        <textarea id="contextText4" placeholder="z.B. Nahaufnahme von Materialstruktur, Beschriftung..."></textarea>
                    </div>
                </div>
            </div>

            <button class="btn analyze-btn" id="analyzeBtn" onclick="analyzeArtifact()" disabled>üîç Konservierungsanalyse starten</button>
        </div>

        <!-- Lade-Animation -->
        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <p>Analysiere Artefakt f√ºr Konservierung...</p>
        </div>

        <!-- Ergebnis -->
        <div id="resultSection" class="result-section hidden">
            <h3 style="margin-bottom: 15px; color: #333;">Konservierungs-Analyse:</h3>
            <div id="resultBox" class="result-box"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="newAnalysis()">üîÑ Neue Analyse</button>
                <button class="btn btn-secondary" onclick="saveAsPDF()">üìÑ Als PDF speichern</button>
                <button class="btn btn-secondary" onclick="saveAsText()">üíæ Als Text speichern</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            Powered by <strong><a href="https://heimatverein-vorchdorf.at" target="_blank">Heimatverein Vorchdorf</a></strong>
        </div>
    </div>

    <!-- jsPDF Bibliothek f√ºr PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let images = [null, null, null, null];
        let contextTexts = ['', '', '', ''];
        let selectedUsage = null;
        let currentAnalysis = null;
        let apiKey = 'AIzaSyAtE1Nsu609m2KuCGXP8whnNZWB_sUugcE';

        // App direkt starten
        window.onload = function() {
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('usageSection').classList.remove('hidden');
        };


        function selectUsage(usage) {
            selectedUsage = usage;

            // Alle Optionen zur√ºcksetzen
            document.querySelectorAll('.usage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Ausgew√§hlte Option markieren
            event.target.closest('.usage-option').classList.add('selected');

            // Upload-Bereich anzeigen
            document.getElementById('uploadSection').classList.remove('hidden');
        }

        function handleImageUpload(slotNumber, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Maximale Gr√∂√üe: 1600px
                    const maxSize = 1600;
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    images[slotNumber - 1] = canvas.toDataURL('image/jpeg', 0.8);

                    // Vorschau anzeigen
                    const previewContainer = document.getElementById('preview' + slotNumber);
                    previewContainer.innerHTML = `
                        <img src="${images[slotNumber - 1]}" class="image-preview-small">
                        <button class="remove-image" onclick="removeImage(${slotNumber})">√ó</button>
                    `;

                    // Kontext-Textfeld anzeigen
                    document.getElementById('context' + slotNumber).style.display = 'block';
                    document.getElementById('slot' + slotNumber).classList.add('has-image');

                    // Analyse-Button aktivieren wenn mindestens ein Bild vorhanden
                    updateAnalyzeButton();
                    hideError();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeImage(slotNumber) {
            images[slotNumber - 1] = null;
            contextTexts[slotNumber - 1] = '';

            document.getElementById('preview' + slotNumber).innerHTML = '';
            document.getElementById('context' + slotNumber).style.display = 'none';
            document.getElementById('contextText' + slotNumber).value = '';
            document.getElementById('imageInput' + slotNumber).value = '';
            document.getElementById('slot' + slotNumber).classList.remove('has-image');

            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const hasImages = images.some(img => img !== null);
            document.getElementById('analyzeBtn').disabled = !hasImages;
        }

        async function analyzeArtifact() {
            // Kontext-Texte sammeln
            for (let i = 0; i < 4; i++) {
                const textarea = document.getElementById('contextText' + (i + 1));
                if (textarea) {
                    contextTexts[i] = textarea.value.trim();
                }
            }

            // UI Updates
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            hideError();

            try {
                // Prompt erstellen
                let prompt = buildConservationPrompt();

                // Contents f√ºr Gemini API vorbereiten
                let parts = [{ text: prompt }];

                // Bilder hinzuf√ºgen
                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        const base64Data = images[i].split(',')[1];
                        parts.push({
                            inline_data: {
                                mime_type: 'image/jpeg',
                                data: base64Data
                            }
                        });

                        if (contextTexts[i]) {
                            parts.push({
                                text: `Kontext-Information zu Bild ${i + 1}: ${contextTexts[i]}`
                            });
                        }
                    }
                }

                // Anfrage an Google Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Fehler (Status ${response.status})`);
                }

                const data = await response.json();
                currentAnalysis = data.candidates[0].content.parts[0].text;

                // Ergebnis anzeigen
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultBox').textContent = currentAnalysis;
                document.getElementById('resultSection').classList.remove('hidden');

            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');

                let errorMessage = 'Fehler bei der Analyse: ' + error.message;

                if (error.message.includes('401') || error.message.includes('403') || error.message.includes('API_KEY')) {
                    errorMessage = 'Authentifizierungsfehler: Der API-Key ist ung√ºltig.\n\nBitte √ºberpr√ºfe deinen Google Gemini API-Key.';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Zu viele Anfragen: Bitte warte einen Moment.';
                } else if (error.message.includes('500') || error.message.includes('503')) {
                    errorMessage = 'Server-Fehler: Bitte versuche es sp√§ter erneut.';
                }

                showError(errorMessage);
            }
        }

        function buildConservationPrompt() {
            const usageTexts = {
                'exhibition': 'Dauerausstellung (Artefakt wird dauerhaft ausgestellt und ist Licht, Besuchern und Umwelteinfl√ºssen ausgesetzt)',
                'temporary': 'Wechselausstellung (Tempor√§re Ausstellung mit Transport und wechselnden Bedingungen)',
                'storage': 'Langzeitlagerung im Depot (Optimale Konservierung ohne Besucherverkehr)',
                'transport': 'Transport (Artefakt muss sicher transportiert werden)'
            };

            const usage = selectedUsage ? usageTexts[selectedUsage] : 'Nicht angegeben';

            return `Du bist ein Experte f√ºr Konservierung und Restaurierung von Museumsobjekten. Analysiere das/die hochgeladene(n) Bild(er) eines Artefakts sehr detailliert im Hinblick auf Konservierung und Erhaltung.

VERWENDUNGSZWECK: ${usage}

Bitte analysiere folgende Aspekte SEHR DETAILLIERT und wissenschaftlich fundiert:

1. MATERIAL-IDENTIFIKATION:
   - Um welches Material handelt es sich? (Holz, Metall, Papier, Textil, Keramik, Glas, etc.)
   - Wenn mehrere Materialien: genaue Auflistung aller Komponenten
   - Materialbesonderheiten (Holzart, Metalllegierung, Papiertyp, etc.)

2. ERHALTUNGSZUSTAND (detaillierte Schadensdokumentation):
   - Sichtbare Sch√§den (Risse, Br√ºche, Fehlstellen)
   - Oberfl√§chenver√§nderungen (Verf√§rbungen, Flecken, Ausbleichungen)
   - Korrosion oder Oxidation (bei Metall)
   - Schimmel, Insektenbefall, Holzw√ºrmer
   - Mechanische Besch√§digungen
   - Alterungserscheinungen
   - Fr√ºhere Restaurierungen erkennbar?

3. AKUTE GEFAHREN & PROBLEME:
   - Welche Sch√§den sind JETZT sichtbar?
   - Welche Probleme werden sich in Zukunft entwickeln?
   - Dringlichkeit der Behandlung (sofort, kurzfristig, mittelfristig)

4. EMPFOHLENE KONSERVIERUNGSMASSNAHMEN:
   - Sofortma√ünahmen zur Stabilisierung
   - Reinigungsempfehlungen (Methoden, Materialien, Vorsichtsma√ünahmen)
   - Notwendige Reparaturen und Restaurierungen
   - Sch√§dlingsbek√§mpfung falls n√∂tig (Vergasung, Tiefk√ºhlung, chemische Behandlung)

5. LAGERUNGSEMPFEHLUNGEN (spezifisch f√ºr das Material):
   - Optimale Temperatur (¬∞C)
   - Optimale relative Luftfeuchtigkeit (%)
   - UV-Schutz und Lichtexposition (Lux-Werte)
   - Verpackungsmaterial (s√§urefreies Papier, Seidenpapier, Tyvek, etc.)
   - Lagerungsposition und Unterst√ºtzung
   - Box/Beh√§lter-Empfehlungen
   - Dunkle vs. klimatisierte Lagerung

6. AUSSTELLUNGSBEDINGUNGEN (falls relevant):
   - Unterschied zwischen Depot und Ausstellung
   - Maximale Lichtexposition (Lux und Stunden pro Tag)
   - UV-Filter und Beleuchtung
   - Vitrinen-Empfehlungen
   - Besucherschutz vs. Sichtbarkeit
   - Klimakontrolle in Ausstellungsr√§umen

7. TRANSPORT-EMPFEHLUNGEN (falls relevant):
   - Verpackungsmethode
   - Polsterung und Fixierung
   - Klimatische Bedingungen w√§hrend Transport
   - Vibrations- und Sto√üschutz

8. MATERIALSPEZIFISCHE HINWEISE:

   HOLZ: Holzw√ºrmer, Risse, Feuchtigkeit, Pilzbefall, Holzart-spezifische Probleme
   METALL: Korrosion, Rost, Gr√ºnspan, Patina (erhaltenswert?), Reinigungsmittel
   PAPIER/PERGAMENT: S√§urefra√ü, Vergilbung, Risse, Tintenkorrosion, Schimmel
   TEXTIL: Faserzerfall, Lichtsch√§den, Flecken, Insekten (Motten)
   LEDER: Austrocknung, Risse, Red Rot (Pulverisierung), Fettung
   GLAS: Risse, Glaskorrosion, Weeping Glass, Reinigung
   KERAMIK: Risse, Abplatzungen, Salzausbl√ºhungen
   GEM√ÑLDE: Craquel√©, Farbabbl√§tterung, Firnis-Vergilbung, Leinwandsch√§den
   FOTOGRAFIE: Verblassen, Silberspiegelung, Verf√§rbung, Emulsionsabl√∂sung

9. WISSENSCHAFTLICHE QUELLEN & STANDARDS:
   - Nenne relevante Konservierungsstandards (z.B. DIN, ISO, IIC)
   - Falls m√∂glich: Referenz zu Fachpublikationen

10. ZUSAMMENFASSUNG & PRIORIT√ÑTEN:
   - Die 3 wichtigsten Sofortma√ünahmen
   - Langfristige Konservierungsstrategie
   - Gesch√§tzte Kosten und Aufwand (grobe Einsch√§tzung)

WICHTIG: Sei sehr detailliert und wissenschaftlich pr√§zise. Nenne konkrete Werte (Temperatur, Luftfeuchtigkeit, Lux), konkrete Materialien und Methoden. Wenn etwas unklar ist, frage nach zus√§tzlichen Informationen oder Bildern.

Antworte auf Deutsch.`;
        }

        function newAnalysis() {
            // Reset
            images = [null, null, null, null];
            contextTexts = ['', '', '', ''];
            selectedUsage = null;
            currentAnalysis = null;

            // UI Reset
            for (let i = 1; i <= 4; i++) {
                document.getElementById('preview' + i).innerHTML = '';
                document.getElementById('context' + i).style.display = 'none';
                document.getElementById('contextText' + i).value = '';
                document.getElementById('imageInput' + i).value = '';
                document.getElementById('slot' + i).classList.remove('has-image');
            }

            document.querySelectorAll('.usage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('usageSection').classList.remove('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            hideError();
        }

        function saveAsText() {
            if (!currentAnalysis) return;

            const timestamp = new Date().toLocaleString('de-AT');
            const usageTexts = {
                'exhibition': 'Dauerausstellung',
                'temporary': 'Wechselausstellung',
                'storage': 'Langzeitlagerung',
                'transport': 'Transport'
            };

            let content = `KONSERVIERUNGS-ANALYSE\n${'='.repeat(70)}\n`;
            content += `Zeitpunkt: ${timestamp}\n`;
            content += `Verwendungszweck: ${usageTexts[selectedUsage] || 'Nicht angegeben'}\n`;
            content += `${'='.repeat(70)}\n\n`;

            // Kontext-Informationen
            let hasContext = false;
            for (let i = 0; i < 4; i++) {
                if (images[i] && contextTexts[i]) {
                    if (!hasContext) {
                        content += `KONTEXT-INFORMATIONEN:\n${'-'.repeat(70)}\n`;
                        hasContext = true;
                    }
                    content += `Bild ${i + 1}: ${contextTexts[i]}\n`;
                }
            }
            if (hasContext) content += `\n`;

            content += `ANALYSE:\n${'-'.repeat(70)}\n${currentAnalysis}\n\n`;
            content += `${'='.repeat(70)}\n`;
            content += `Powered by Heimatverein Vorchdorf\n`;
            content += `https://heimatverein-vorchdorf.at\n`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Konservierung_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function saveAsPDF() {
            if (!currentAnalysis) return;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;
            let yPosition = margin;

            // Titel
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('KONSERVIERUNGS-ANALYSE', margin, yPosition);
            yPosition += 10;

            // Metadata
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const timestamp = new Date().toLocaleString('de-AT');
            pdf.text(`Zeitpunkt: ${timestamp}`, margin, yPosition);
            yPosition += 6;

            const usageTexts = {
                'exhibition': 'Dauerausstellung',
                'temporary': 'Wechselausstellung',
                'storage': 'Langzeitlagerung',
                'transport': 'Transport'
            };
            pdf.text(`Verwendungszweck: ${usageTexts[selectedUsage] || 'Nicht angegeben'}`, margin, yPosition);
            yPosition += 10;

            // Bilder hinzuf√ºgen
            const imageCount = images.filter(img => img !== null).length;
            if (imageCount > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('BILDER:', margin, yPosition);
                yPosition += 8;

                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        // Neue Seite wenn n√∂tig
                        if (yPosition > pageHeight - 80) {
                            pdf.addPage();
                            yPosition = margin;
                        }

                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`Bild ${i + 1}:`, margin, yPosition);
                        yPosition += 6;

                        // Kontext-Info
                        if (contextTexts[i]) {
                            pdf.setFont(undefined, 'italic');
                            const contextLines = pdf.splitTextToSize(`Kontext: ${contextTexts[i]}`, contentWidth);
                            pdf.text(contextLines, margin, yPosition);
                            yPosition += contextLines.length * 5 + 4;
                        }

                        // Bild einf√ºgen
                        const imgWidth = contentWidth;
                        const imgHeight = 60;
                        pdf.addImage(images[i], 'JPEG', margin, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 10;
                    }
                }
            }

            // Neue Seite f√ºr Analyse
            pdf.addPage();
            yPosition = margin;

            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('KONSERVIERUNGS-ANALYSE:', margin, yPosition);
            yPosition += 8;

            // Analyse-Text
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            const lines = pdf.splitTextToSize(currentAnalysis, contentWidth);

            for (let i = 0; i < lines.length; i++) {
                if (yPosition > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                }
                pdf.text(lines[i], margin, yPosition);
                yPosition += 5;
            }

            // Footer auf letzter Seite
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'italic');
            pdf.text('Powered by Heimatverein Vorchdorf', margin, pageHeight - 10);

            // PDF speichern
            pdf.save(`Konservierung_${Date.now()}.pdf`);
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.textContent = message;
            errorSection.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }
    </script>
</body>
</html>
