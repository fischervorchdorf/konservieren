<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konservieren - Artefakt Analyse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --museum-gold: #d97706;
            --museum-charcoal: #1f2937;
            --museum-paper: #fef3c7;
            --museum-stone: #e5e7eb;
            --gold-gradient-start: #b45309;
            --gold-gradient-end: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--museum-paper);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: var(--museum-charcoal);
        }

        /* Dark Header wie WasBinIch */
        .header {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: var(--museum-gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.1em;
        }

        .header-subtitle {
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.7);
        }

        .header-badge {
            background: rgba(217, 119, 6, 0.2);
            border: 1px solid var(--museum-gold);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--museum-gold);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        /* Hero Section wie WasBinIch */
        .hero {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 60px;
        }

        .hero-badge {
            display: inline-block;
            padding: 8px 16px;
            border: 2px solid rgba(217, 119, 6, 0.3);
            border-radius: 50px;
            background: rgba(217, 119, 6, 0.05);
            margin-bottom: 20px;
        }

        .hero-badge-text {
            color: var(--museum-gold);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        .hero-title {
            font-family: 'Cinzel', serif;
            font-size: 56px;
            line-height: 1.2;
            margin-bottom: 20px;
            font-weight: 400;
            color: var(--museum-charcoal);
        }

        .hero-title-emphasis {
            display: block;
            font-weight: 700;
            font-style: italic;
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
        }

        .hero-description {
            font-size: 16px;
            line-height: 1.6;
            color: #6b7280;
            max-width: 600px;
            margin: 0 auto;
        }

        .api-key-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .api-key-section.hidden {
            display: none;
        }

        .api-key-section h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .api-key-section p {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .api-key-section a {
            color: #667eea;
            text-decoration: none;
        }

        .api-key-section a:hover {
            text-decoration: underline;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 32px;
            border: 1px solid var(--museum-charcoal);
            border-radius: 2px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.4);
            background: linear-gradient(135deg, #a3470a, #f59e0b);
        }

        .btn-secondary {
            background: transparent;
            color: var(--museum-charcoal);
            border: 1px solid var(--museum-stone);
            padding: 12px 24px;
            font-size: 11px;
        }

        .btn-secondary:hover {
            border-color: var(--museum-gold);
            background: white;
            color: var(--museum-gold);
        }

        .usage-section {
            margin-bottom: 30px;
        }

        .usage-section.hidden {
            display: none;
        }

        .usage-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .usage-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .usage-option {
            padding: 20px;
            border: 2px solid var(--museum-stone);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            background: white;
        }

        .usage-option:hover {
            border-color: var(--museum-gold);
            background: rgba(217, 119, 6, 0.05);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.15);
            transform: translateY(-4px);
        }

        .usage-option.selected {
            border-color: var(--museum-gold);
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05));
            border-width: 2px;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.2);
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-section.hidden {
            display: none;
        }

        /* Modern Upload Area wie WasBinIch */
        .upload-area {
            border: 2px dashed rgba(217, 119, 6, 0.4);
            border-radius: 16px;
            padding: 48px 32px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s;
            margin-bottom: 40px;
        }

        .upload-area:hover {
            border-color: var(--museum-gold);
            background: rgba(217, 119, 6, 0.02);
        }

        .upload-icon-container {
            width: 80px;
            height: 80px;
            background: rgba(217, 119, 6, 0.1);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .upload-icon {
            font-size: 40px;
        }

        .upload-title {
            font-family: 'Cinzel', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--museum-charcoal);
            margin-bottom: 12px;
        }

        .upload-description {
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 15px;
            line-height: 1.6;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .upload-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .upload-button-gallery {
            background: var(--museum-charcoal);
            color: white;
            border: none;
        }

        .upload-button-gallery:hover {
            background: #111827;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .upload-button-camera {
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            color: white;
            border: none;
        }

        .upload-button-camera:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(217, 119, 6, 0.3);
        }

        .upload-hint {
            font-size: 13px;
            color: #9ca3af;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .image-slot {
            border: 2px dashed var(--museum-stone);
            border-radius: 2px;
            padding: 15px;
            text-align: center;
            position: relative;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            background: rgba(249, 248, 246, 0.5);
        }

        .image-slot.has-image {
            border-style: solid;
            border-color: var(--museum-gold);
            background: white;
            box-shadow: 0 4px 16px rgba(217, 119, 6, 0.2);
        }

        .image-preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
        }

        .image-preview-small {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 5px;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .remove-image:hover {
            background: #c82333;
        }

        .image-context {
            margin-top: 10px;
        }

        .image-context textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .image-context textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-context label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .upload-btn-small {
            padding: 10px 20px;
            font-size: 14px;
            min-height: auto;
        }

        .upload-btn {
            position: relative;
            overflow: hidden;
        }

        .upload-btn input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .analyze-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            color: white;
            padding: 20px;
            font-size: 14px;
            min-height: auto;
            border: none;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(217, 119, 6, 0.4);
            background: linear-gradient(135deg, #a3470a, #f59e0b);
        }

        .analyze-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            margin-bottom: 30px;
        }

        .result-section.hidden {
            display: none;
        }



        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--museum-charcoal);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.1em;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid var(--museum-stone);
            border-top: 3px solid var(--museum-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .error.hidden {
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid var(--museum-stone);
            color: var(--museum-gold);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .footer a {
            color: var(--museum-gold);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: var(--museum-charcoal);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .usage-options {
                grid-template-columns: 1fr;
            }
        }

        /* Priority Banner - Redesigned for Maximum Impact */
        .priority-hero {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            position: relative;
        }

        .priority-hero.kritisch {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 3px solid #dc2626;
        }

        .priority-hero.hoch {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border: 3px solid #ea580c;
        }

        .priority-hero.mittel {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border: 3px solid #ca8a04;
        }

        .priority-hero.stabil {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 3px solid #16a34a;
        }

        .priority-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .priority-badge {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 28px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .priority-badge.kritisch {
            background: linear-gradient(to right, #dc2626, #991b1b);
            color: white;
        }

        .priority-badge.hoch {
            background: linear-gradient(to right, #ea580c, #c2410c);
            color: white;
        }

        .priority-badge.mittel {
            background: linear-gradient(to right, #ca8a04, #a16207);
            color: white;
        }

        .priority-badge.stabil {
            background: linear-gradient(to right, #16a34a, #15803d);
            color: white;
        }

        .priority-gauges {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 24px;
            margin: 30px 0;
        }

        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .gauge-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--gauge-color) calc(var(--gauge-value) * 3.6deg), #e5e7eb calc(var(--gauge-value) * 3.6deg));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .gauge-inner {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 800;
            color: var(--museum-charcoal);
        }

        .gauge-label {
            font-size: 10px;
            font-weight: 700;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            /* Space between label and circle */
            height: auto;
            display: block;
        }

        .gauge-description {
            font-size: 13px;
            font-weight: 600;
            color: var(--museum-charcoal);
            margin-top: 4px;
        }

        .priority-justification-box {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            font-size: 16px;
            line-height: 1.7;
            color: var(--museum-charcoal);
            border-left: 4px solid var(--museum-gold);
        }

        /* Section Blocks - Colorful Gradients */
        .section-block {
            margin-bottom: 48px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(0, 0, 0, 0.05);
        }

        .section-header {
            padding: 24px 32px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .section-header .icon {
            font-size: 32px;
        }

        .section-body {
            background: white;
            padding: 32px;
            font-size: 16px;
            line-height: 1.8;
            color: var(--museum-charcoal);
        }

        /* Section Color Themes */
        .section-blue .section-header {
            background: linear-gradient(to right, #0c4a6e, #0f766e);
        }

        .section-blue .section-body {
            background: linear-gradient(to bottom, #e0f2fe, white);
        }

        .section-purple .section-header {
            background: linear-gradient(to right, #581c87, #4338ca);
        }

        .section-purple .section-body {
            background: linear-gradient(to bottom, #ede9fe, white);
        }

        .section-red .section-header {
            background: linear-gradient(to right, #7f1d1d, #9a3412);
        }

        .section-red .section-body {
            background: linear-gradient(to bottom, #fef2f2, white);
        }

        .section-green .section-header {
            background: linear-gradient(to right, #064e3b, #14532d);
        }

        .section-green .section-body {
            background: linear-gradient(to bottom, #d1fae5, white);
        }

        .section-amber .section-header {
            background: linear-gradient(to right, #78350f, #713f12);
        }

        .section-amber .section-body {
            background: linear-gradient(to bottom, #fffbeb, white);
        }

        .section-orange .section-header {
            background: linear-gradient(to right, #9a3412, #ea580c);
        }

        .section-orange .section-body {
            background: linear-gradient(to bottom, #fff7ed, white);
        }

        /* Content Formatting */
        .section-body p {
            margin-bottom: 16px;
        }

        .section-body strong {
            color: var(--museum-gold);
            font-weight: 700;
        }

        .section-body ul {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .section-body li {
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f9fafb;
            border-left: 4px solid var(--museum-gold);
            border-radius: 6px;
        }

        .section-body a {
            color: var(--museum-gold);
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s;
        }

        .section-body a:hover {
            border-bottom-color: var(--museum-gold);
        }

        .value-badge {
            display: inline-block;
            background: var(--museum-gold);
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            margin: 0 4px;
        }
    </style>
</head>

<body>
    <!-- Dark Header wie WasBinIch -->
    <header class="header">
        <div class="header-content">
            <div class="header-logo">
                <div class="header-icon">üèõÔ∏è</div>
                <div>
                    <div class="header-title">KONSERVIEREN <span
                            style="font-size: 12px; opacity: 0.7; font-weight: 400;">v2.20</span></div>
                    <div class="header-subtitle">Artefakt-Analyse f√ºr Museum & Archiv</div>
                </div>
            </div>
            <div class="header-badge">
                ‚ú® KI-Powered
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section wie WasBinIch -->
        <div class="hero" id="heroSection">
            <div class="hero-badge">
                <span class="hero-badge-text">KI-Powered Konservierungs-Analyse</span>
            </div>
            <h1 class="hero-title">
                Jedes Artefakt
                <span class="hero-title-emphasis">braucht Pflege</span>
            </h1>
            <p class="hero-description">
                Lade Bilder deines Artefakts hoch und erhalte eine detaillierte Konservierungsanalyse ‚Äì
                wissenschaftlich fundiert und praxisnah f√ºr Museums- und Archivbest√§nde.
            </p>
        </div>

        <!-- API Key Eingabe -->
        <div id="apiKeySection" class="api-key-section">
            <h3>üîë Google Gemini API Key eingeben</h3>
            <p>
                Du ben√∂tigst einen Google Gemini API Key (kostenlos!).<br>
                Hole dir deinen Key auf <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI
                    Studio</a>.<br>
                Kostenlos: 15 Anfragen pro Minute, 1500 pro Tag.
            </p>
            <div class="api-input-group">
                <input type="password" id="apiKeyInput" placeholder="AIzaSy..." />
                <button class="btn btn-primary" onclick="saveApiKey()">Speichern</button>
            </div>
        </div>

        <!-- Fehleranzeige -->
        <div id="errorSection" class="error hidden"></div>

        <!-- Upload Bereich -->
        <div id="uploadSection" class="upload-section">
            <!-- Modern Upload Area wie WasBinIch -->
            <div class="upload-area">
                <div class="upload-icon-container">
                    <span class="upload-icon">üì§</span>
                </div>
                <h2 class="upload-title">Artefakt hochladen</h2>
                <p class="upload-description">
                    Lade 1-6 Bilder deines Artefakts hoch oder mache ein Foto. Mehrere Perspektiven und Details helfen
                    bei der
                    Analyse.
                </p>

                <!-- Upload Buttons wie WasBinIch -->
                <div class="upload-buttons">
                    <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;"
                        onchange="handleMultiImageUpload(event)">
                    <button class="upload-button upload-button-gallery"
                        onclick="document.getElementById('galleryInput').click()">
                        <span>üñºÔ∏è</span>
                        <span>Galerie</span>
                    </button>

                    <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple
                        style="display: none;" onchange="handleMultiImageUpload(event)">
                    <button class="upload-button upload-button-camera"
                        onclick="document.getElementById('cameraInput').click()">
                        <span>üì∑</span>
                        <span>Foto aufnehmen</span>
                    </button>
                </div>

                <p class="upload-hint">
                    üí° Mehrere Perspektiven helfen bei der Identifizierung
                </p>
            </div>

            <div class="images-grid" id="imagesGrid">
                <div class="image-slot" id="slot1">
                    <div class="image-preview-container" id="preview1"></div>
                    <div class="upload-btn">
                        <label for="imageInput1" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 1 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput1" accept="image/*" capture="environment"
                            onchange="handleImageUpload(1, event)">
                    </div>
                    <div class="image-context" id="context1" style="display: none;">
                        <label>Kontext-Information zu Bild 1:</label>
                        <textarea id="contextText1"
                            placeholder="z.B. Gesamtansicht, lagert seit 10 Jahren bei 60% Luftfeuchtigkeit, Temperatur 18¬∞C..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot2">
                    <div class="image-preview-container" id="preview2"></div>
                    <div class="upload-btn">
                        <label for="imageInput2" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 2 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput2" accept="image/*" capture="environment"
                            onchange="handleImageUpload(2, event)">
                    </div>
                    <div class="image-context" id="context2" style="display: none;">
                        <label>Kontext-Information zu Bild 2:</label>
                        <textarea id="contextText2"
                            placeholder="z.B. Detailaufnahme eines Schadens, Verf√§rbung, Riss..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot3">
                    <div class="image-preview-container" id="preview3"></div>
                    <div class="upload-btn">
                        <label for="imageInput3" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 3 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput3" accept="image/*" capture="environment"
                            onchange="handleImageUpload(3, event)">
                    </div>
                    <div class="image-context" id="context3" style="display: none;">
                        <label>Kontext-Information zu Bild 3:</label>
                        <textarea id="contextText3"
                            placeholder="z.B. R√ºckseite, Unterseite, Materialdetails..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot4">
                    <div class="image-preview-container" id="preview4"></div>
                    <div class="upload-btn">
                        <label for="imageInput4" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 4 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput4" accept="image/*" capture="environment"
                            onchange="handleImageUpload(4, event)">
                    </div>
                    <div class="image-context" id="context4" style="display: none;">
                        <label>Kontext-Information zu Bild 4:</label>
                        <textarea id="contextText4"
                            placeholder="z.B. Nahaufnahme von Materialstruktur, Beschriftung..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot5">
                    <div class="image-preview-container" id="preview5"></div>
                    <div class="upload-btn">
                        <label for="imageInput5" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 5 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput5" accept="image/*" capture="environment"
                            onchange="handleImageUpload(5, event)">
                    </div>
                    <div class="image-context" id="context5" style="display: none;">
                        <label>Kontext-Information zu Bild 5:</label>
                        <textarea id="contextText5"
                            placeholder="z.B. Weitere Detailaufnahme, Markierungen, Stempel..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot6">
                    <div class="image-preview-container" id="preview6"></div>
                    <div class="upload-btn">
                        <label for="imageInput6" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 6 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput6" accept="image/*" capture="environment"
                            onchange="handleImageUpload(6, event)">
                    </div>
                    <div class="image-context" id="context6" style="display: none;">
                        <label>Kontext-Information zu Bild 6:</label>
                        <textarea id="contextText6"
                            placeholder="z.B. Gesamt√ºbersicht, weitere Perspektive..."></textarea>
                    </div>
                </div>
            </div>

            <button class="btn analyze-btn" id="analyzeBtn" onclick="analyzeArtifact()" disabled>üîç
                Konservierungsanalyse starten</button>
        </div>

        <!-- Lade-Animation -->
        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <p>Analysiere Artefakt f√ºr Konservierung...</p>
        </div>

        <!-- Ergebnis -->
        <div id="resultSection" class="result-section hidden">
            <h3 style="margin-bottom: 15px; color: #333;">Konservierungs-Analyse:</h3>
            <div id="resultBox" class="result-box"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="newAnalysis()">üîÑ Neue Analyse</button>
                <button class="btn btn-secondary" onclick="saveAsPDF()">üìÑ Als PDF speichern</button>
                <button class="btn btn-secondary" onclick="saveAsText()">üíæ Als Text speichern</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            Powered by <strong><a href="https://heimatverein-vorchdorf.at" target="_blank">Heimatverein
                    Vorchdorf</a></strong> | v2.5
        </div>
    </div>

    <!-- jsPDF Bibliothek f√ºr PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let images = [null, null, null, null, null, null];
        let contextTexts = ['', '', '', '', '', ''];
        let currentAnalysis = null;
        // Reversed for security
        let apiKey = "MLER-xWuOFzQn1LnnauHdpiBk5b2qT2k2DySazIA".split("").reverse().join("");

        // Automatically show upload section on load
        window.onload = function () {
            // Load saved API key if available - DISABLED to force new valid key
            // const savedKey = localStorage.getItem('gemini_api_key');
            // if (savedKey) {
            //     apiKey = savedKey;
            //     document.getElementById('apiKeyInput').value = savedKey;
            // }
            localStorage.removeItem('gemini_api_key'); // Force remove old key

            // Show upload section directly
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('apiKeySection').classList.add('hidden'); // Ensure API key section is hidden
        };

        function handleImageUpload(slotNumber, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Maximale Gr√∂√üe: 1600px
                    const maxSize = 1600;
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    images[slotNumber - 1] = canvas.toDataURL('image/jpeg', 0.8);

                    // Vorschau anzeigen
                    const previewContainer = document.getElementById('preview' + slotNumber);
                    previewContainer.innerHTML = `
                        <img src="${images[slotNumber - 1]}" class="image-preview-small">
                        <button class="remove-image" onclick="removeImage(${slotNumber})">√ó</button>
                    `;

                    // Kontext-Textfeld anzeigen
                    document.getElementById('context' + slotNumber).style.display = 'block';
                    document.getElementById('slot' + slotNumber).classList.add('has-image');

                    // Analyse-Button aktivieren wenn mindestens ein Bild vorhanden
                    updateAnalyzeButton();
                    hideError();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleMultiImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            // Max 6 images
            const maxImages = 6;
            const filesToProcess = Array.from(files).slice(0, maxImages);

            // Process each file and assign to next available slot
            filesToProcess.forEach((file, index) => {
                // Find next empty slot
                let slotNumber = index + 1;

                // If slot already has image, find next empty one
                while (slotNumber <= 6 && images[slotNumber - 1] !== null) {
                    slotNumber++;
                }

                if (slotNumber > 6) return; // No more slots available

                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Maximale Gr√∂√üe: 1600px
                        const maxSize = 1600;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        images[slotNumber - 1] = canvas.toDataURL('image/jpeg', 0.8);

                        // Vorschau anzeigen
                        const previewContainer = document.getElementById('preview' + slotNumber);
                        previewContainer.innerHTML = `
                            <img src="${images[slotNumber - 1]}" class="image-preview-small">
                            <button class="remove-image" onclick="removeImage(${slotNumber})">√ó</button>
                        `;

                        // Kontext-Textfeld anzeigen
                        document.getElementById('context' + slotNumber).style.display = 'block';
                        document.getElementById('slot' + slotNumber).classList.add('has-image');

                        // Analyse-Button aktivieren
                        updateAnalyzeButton();
                        hideError();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // Clear the input so the same files can be selected again if needed
            event.target.value = '';
        }

        function removeImage(slotNumber) {
            images[slotNumber - 1] = null;
            contextTexts[slotNumber - 1] = '';

            document.getElementById('preview' + slotNumber).innerHTML = '';
            document.getElementById('context' + slotNumber).style.display = 'none';
            document.getElementById('contextText' + slotNumber).value = '';
            document.getElementById('imageInput' + slotNumber).value = '';
            document.getElementById('slot' + slotNumber).classList.remove('has-image');

            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const hasImages = images.some(img => img !== null);
            document.getElementById('analyzeBtn').disabled = !hasImages;
        }

        async function analyzeArtifact() {
            // Kontext-Texte sammeln
            for (let i = 0; i < 6; i++) {
                const textarea = document.getElementById('contextText' + (i + 1));
                if (textarea) {
                    contextTexts[i] = textarea.value.trim();
                }
            }

            // UI Updates
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            hideError();

            try {
                // Prompt erstellen
                let prompt = buildConservationPrompt();

                // Contents f√ºr Gemini API vorbereiten
                let parts = [{ text: prompt }];

                // Bilder hinzuf√ºgen
                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        const base64Data = images[i].split(',')[1];
                        parts.push({
                            inline_data: {
                                mime_type: 'image/jpeg',
                                data: base64Data
                            }
                        });

                        if (contextTexts[i]) {
                            parts.push({
                                text: `Kontext-Information zu Bild ${i + 1}: ${contextTexts[i]}`
                            });
                        }
                    }
                }

                // Anfrage an Google Gemini
                // Using gemini-2.5-flash (same as WasBinIch app - tested and working)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Fehler (Status ${response.status})`);
                }

                const data = await response.json();
                currentAnalysis = data.candidates[0].content.parts[0].text;

                // Ergebnis anzeigen
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultBox').innerHTML = formatAnalysisResult(currentAnalysis);
                document.getElementById('resultSection').classList.remove('hidden');

                // Scroll to top of result
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');

                let errorMessage = 'Fehler bei der Analyse: ' + error.message;

                if (error.message.includes('401') || error.message.includes('403') || error.message.includes('API_KEY')) {
                    errorMessage = 'Authentifizierungsfehler: Der API-Key ist ung√ºltig.\n\nBitte √ºberpr√ºfe deinen Google Gemini API-Key.';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Zu viele Anfragen: Bitte warte einen Moment.';
                    errorMessage = 'Server-Fehler: Bitte versuche es sp√§ter erneut.';
                }

                showError(errorMessage);
            }
        }

        function formatAnalysisResult(text) {
            let html = '';

            // --- 1. PARSE PRIORITY SECTION ---
            const priorityMatch = text.match(/###SECTION_START: PRIORITY###([\s\S]*?)###SECTION_END: PRIORITY###/);

            // Defaults
            let urgency = 5, rarity = 5, historicalValue = 5, condition = 5;
            let overall = 'MITTEL';
            let justification = '';
            let dating = 'Unbekannt';
            let title = 'Unbekanntes Objekt';

            if (priorityMatch) {
                const pText = priorityMatch[1];
                urgency = parseInt(pText.match(/DRINGLICHKEIT:\s*(\d+)/i)?.[1] || '5');
                rarity = parseInt(pText.match(/SELTENHEIT:\s*(\d+)/i)?.[1] || '5');
                historicalValue = parseInt(pText.match(/WERT:\s*(\d+)/i)?.[1] || '5');
                condition = parseInt(pText.match(/ZUSTAND:\s*(\d+)/i)?.[1] || '5');
                overall = pText.match(/GESAMT:\s*([A-Z]+)/i)?.[1] || 'MITTEL';
                justification = pText.match(/BEGR√úNDUNG:\s*(.+)/i)?.[1]?.trim() || '';
                dating = pText.match(/DATIERUNG:\s*(.+)/i)?.[1]?.trim() || 'Unbekannt';
                title = pText.match(/TITEL:\s*(.+)/i)?.[1]?.trim() || 'Unbekanntes Objekt';
            }

            const overallClass = overall.toLowerCase().replace(/√º/g, 'u');

            // Helper functions for colors and labels (reused)
            function getUrgencyColor(value) {
                if (value <= 3) return '#16a34a';
                if (value <= 6) return '#ca8a04';
                if (value <= 8) return '#ea580c';
                return '#dc2626';
            }
            function getRarityColor(value) {
                if (value <= 3) return '#9ca3af';
                if (value <= 6) return '#78716c';
                if (value <= 8) return '#ca8a04';
                return '#d97706';
            }
            function getValueColor(value) {
                if (value <= 3) return '#9ca3af';
                if (value <= 6) return '#78716c';
                if (value <= 8) return '#ca8a04';
                return '#d97706';
            }
            function getConditionColor(value) {
                if (value <= 3) return '#dc2626';
                if (value <= 6) return '#ea580c';
                if (value <= 8) return '#ca8a04';
                return '#16a34a';
            }

            function getUrgencyLabel(value) {
                if (value <= 3) return '‚úÖ Niedrig';
                if (value <= 6) return '‚ö†Ô∏è Mittel';
                if (value <= 8) return 'üö® Hoch';
                return 'üî• Kritisch!';
            }
            function getRarityLabel(value) {
                if (value <= 2) return '‚ö™ H√§ufig';
                if (value <= 5) return 'üîµ Ungew√∂hnlich';
                if (value <= 8) return 'üü° Selten';
                return 'üü® Sehr selten!';
            }
            function getValueLabel(value) {
                if (value <= 2) return 'üìÑ Geringe Bedeutung';
                if (value <= 5) return 'üìå Wichtig';
                if (value <= 8) return 'üíé Sehr wertvoll';
                return 'üëë Unersetzlich!';
            }
            function getConditionLabel(value) {
                if (value <= 2) return 'üíî Kritisch';
                if (value <= 4) return 'üòü Besch√§digt';
                if (value <= 7) return 'üòä Gut';
                return '‚ú® Exzellent!';
            }

            const badgeIcon = overall.includes('KRITISCH') ? 'üö®' : overall.includes('HOCH') ? '‚ö°' : overall.includes('MITTEL') ? '‚ö†Ô∏è' : '‚úÖ';

            html += `
                <div class="priority-hero ${overallClass}">
                    <div class="priority-header">
                        <div class="priority-badge ${overallClass}">
                            ${badgeIcon}
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 4px;">${title}</div>
                            <div style="font-weight: bold; color: #666;">
                                üïí ${dating}
                            </div>
                        </div>
                    </div>
                    <div class="priority-gauges">
                        <div class="gauge-container">
                            <div class="gauge-label">Dringlichkeit</div>
                            <div class="gauge-circle" style="--gauge-value: ${urgency * 10}; --gauge-color: ${getUrgencyColor(urgency)};">
                                <div class="gauge-inner">${urgency}</div>
                            </div>
                            <div class="gauge-description">${getUrgencyLabel(urgency)}</div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-label">Seltenheit</div>
                            <div class="gauge-circle" style="--gauge-value: ${rarity * 10}; --gauge-color: ${getRarityColor(rarity)};">
                                <div class="gauge-inner">${rarity}</div>
                            </div>
                            <div class="gauge-description">${getRarityLabel(rarity)}</div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-label">Historischer Wert</div>
                            <div class="gauge-circle" style="--gauge-value: ${historicalValue * 10}; --gauge-color: ${getValueColor(historicalValue)};">
                                <div class="gauge-inner">${historicalValue}</div>
                            </div>
                            <div class="gauge-description">${getValueLabel(historicalValue)}</div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-label">Erhaltungszustand</div>
                            <div class="gauge-circle" style="--gauge-value: ${condition * 10}; --gauge-color: ${getConditionColor(condition)};">
                                <div class="gauge-inner">${condition}</div>
                            </div>
                            <div class="gauge-description">${getConditionLabel(condition)}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 0.8em; color: #888; margin-top: -10px; margin-bottom: 20px;">
                        Skala: 1 (Gering) - 10 (Hoch)
                    </div>
                    ${justification ? `<div class="priority-justification-box">üí° <strong>KI-Einsch√§tzung:</strong> ${justification}</div>` : ''}
                </div>
            `;

            // --- 2. PARSE CONTENT SECTIONS ---
            const sections = [
                { id: '1', title: 'Material-Identifikation', icon: 'üî¨', theme: 'blue' },
                { id: '2', title: 'Zustandsanalyse', icon: 'üìã', theme: 'purple' },
                { id: '3', title: 'Risikobewertung', icon: '‚ö†Ô∏è', theme: 'red' },
                { id: '4', title: 'Konservierungskonzept', icon: 'üõ°Ô∏è', theme: 'green' },
                { id: '5', title: 'Handlungsempfehlungen', icon: 'üéØ', theme: 'orange' },
                { id: '6', title: 'Quellen & Literatur', icon: 'üìö', theme: 'amber' }
            ];

            sections.forEach(section => {
                const regex = new RegExp(`###SECTION_START: ${section.id}###([\\s\\S]*?)###SECTION_END: ${section.id}###`);
                const match = text.match(regex);

                if (match) {
                    let content = match[1].trim();

                    // Clean up formatting
                    content = content.replace(/\*\*/g, ''); // Remove all double asterisks
                    content = content.replace(/\n\n+/g, '</p><p>'); // Paragraphs
                    content = content.replace(/\n/g, '<br>'); // Line breaks
                    content = `<p>${content}</p>`;

                    // Linkify URLs in sources
                    if (section.id === '6') {
                        content = content.replace(/(https?:\/\/[^\s<)]+)/g, '<a href="$1" target="_blank">üîó $1</a>');
                    }

                    html += `
                        <div class="section-block section-${section.theme}">
                            <div class="section-header">
                                <span class="icon">${section.icon}</span>
                                <h3>${section.title}</h3>
                            </div>
                            <div class="section-body">${content}</div>
                        </div>
                    `;
                }
            });

            return html;
        }

        function buildConservationPrompt() {
            const today = new Date().toLocaleDateString('de-AT', { year: 'numeric', month: 'long', day: 'numeric' });

            return `ROLLE: Du bist ein konservativer, streng wissenschaftlicher Museumskurator und Restaurator mit 30 Jahren Erfahrung.
AUFGABE: Erstelle ein professionelles Zustandsprotokoll (Condition Report) f√ºr das abgebildete Objekt.
TONFALL: Sachlich, pr√§zise, akademisch. Vermeide blumige Sprache. Faktenbasiert.

KONTEXT:
- Datum: ${today}

ANWEISUNG ZUR BEWERTUNG (SCORING) - SEHR STRENG SEIN:
- 1: Massenware / Industrieprodukt (auch Vintage 50er-80er Jahre) / H√§ufig
- 2-3: Gehobene Manufakturarbeit / Dekorativ
- 4-6: Historisch relevant / Gute Handwerkskunst
- 7-8: Museal bedeutend / Selten
- 9-10: Unikat / Welterbe-Niveau

WICHTIG: Vintage-Objekte (z.B. Taschenuhren, Kameras, Radios) aus Massenproduktion sind NICHT selten und haben meist geringen historischen Wert -> Score 1-2!

FORMATIERUNG (STRENG EINHALTEN):
Nutze exakt diese Trenner. Keine Markdown-Formatierung (kein Fett/Kursiv) innerhalb der Datenfelder.

###SECTION_START: PRIORITY###
TITEL: [Kurzer, pr√§gnanter Name des Objekts, z.B. "Herren-Armbanduhr Omega, 1950er"]
DATIERUNG: [Gesch√§tzter Zeitraum, z.B. "ca. 1950er Jahre"]
DRINGLICHKEIT: [Zahl 1-10]
SELTENHEIT: [Zahl 1-10]
WERT: [Zahl 1-10]
ZUSTAND: [Zahl 1-10]
GESAMT: [KRITISCH | HOCH | MITTEL | STABIL]
BEGR√úNDUNG: [Kurzer, pr√§gnanter Satz]
###SECTION_END: PRIORITY###

###SECTION_START: 1###
[Hier wissenschaftliche Materialanalyse. Nutze Abs√§tze f√ºr Lesbarkeit.]
###SECTION_END: 1###

###SECTION_START: 2###
[Detaillierte Zustandsanalyse. Beschreibe Sch√§den topographisch.]
###SECTION_END: 2###

###SECTION_START: 3###
[Risikobewertung. Was droht dem Objekt?]
###SECTION_END: 3###

###SECTION_START: 4###
[Konservierungskonzept (Basis). Klima (Temp/rF) und Licht (Lux).]
###SECTION_END: 4###

###SECTION_START: 5###
HANDLUNGSEMPFEHLUNGEN F√úR VERSCHIEDENE SZENARIEN:

A. LANGZEITLAGERUNG (DEPOT):
[Spezifische Anweisungen f√ºr das Depot]

B. DAUERAUSSTELLUNG:
[Was ist bei einer Ausstellung zu beachten? Max. Licht, Vitrine?]

C. TRANSPORT:
[Wie muss das Objekt verpackt werden?]
###SECTION_END: 5###

###SECTION_START: 6###
[Quellenverzeichnis. Mindestens 3 relevante Fachquellen/Normen.]
###SECTION_END: 6###

WICHTIG:
- Keine Markdown-Sternchen (**) verwenden!
- Halte dich strikt an die Struktur.
- Sei extrem kritisch bei der Bewertung.`;
        }

        function newAnalysis() {
            // Reset
            images = [null, null, null, null, null, null];
            contextTexts = ['', '', '', '', '', ''];
            currentAnalysis = null;

            // UI Reset
            for (let i = 1; i <= 6; i++) {
                document.getElementById('preview' + i).innerHTML = '';
                document.getElementById('context' + i).style.display = 'none';
                document.getElementById('contextText' + i).value = '';
                document.getElementById('imageInput' + i).value = '';
                document.getElementById('slot' + i).classList.remove('has-image');
            }

            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            hideError();
        }

        function saveAsText() {
            if (!currentAnalysis) return;

            const timestamp = new Date().toLocaleString('de-AT');

            // Extract Title
            const priorityMatch = currentAnalysis.match(/###SECTION_START: PRIORITY###([\s\S]*?)###SECTION_END: PRIORITY###/);
            const title = priorityMatch ? (priorityMatch[1].match(/TITEL:\s*(.+)/i)?.[1]?.trim() || 'Unbekanntes Objekt') : 'Unbekanntes Objekt';

            let content = `KONSERVIERUNGS-ANALYSE\n`;
            content += `${'='.repeat(60)}\n`;
            content += `Objekt: ${title}\n`;
            content += `Zeitpunkt: ${timestamp}\n`;
            content += `${'='.repeat(60)}\n\n`;

            // Kontext-Informationen
            let hasContext = false;
            let contextContent = '';
            for (let i = 0; i < 6; i++) {
                if (images[i] && contextTexts[i]) {
                    contextContent += `Bild ${i + 1}: ${contextTexts[i]}\n`;
                    hasContext = true;
                }
            }
            if (hasContext) {
                content += `DOKUMENTATION\n${'-'.repeat(30)}\n`;
                content += contextContent + `\n`;
            }

            // Parse Sections
            const sections = [
                { id: 'PRIORITY', title: 'ZUSAMMENFASSUNG & PRIORIT√ÑT' },
                { id: '1', title: 'MATERIAL-IDENTIFIKATION' },
                { id: '2', title: 'ZUSTANDSANALYSE' },
                { id: '3', title: 'RISIKOBEWERTUNG' },
                { id: '4', title: 'KONSERVIERUNGSKONZEPT' },
                { id: '5', title: 'HANDLUNGSEMPFEHLUNGEN' },
                { id: '6', title: 'QUELLEN & LITERATUR' }
            ];

            const getSectionContent = (id) => {
                const regex = new RegExp(`###SECTION_START: ${id}###([\\s\\S]*?)###SECTION_END: ${id}###`);
                const match = currentAnalysis.match(regex);
                return match ? match[1].trim() : null;
            };

            sections.forEach(section => {
                let sectionContent = getSectionContent(section.id);
                if (sectionContent) {
                    // Clean content
                    sectionContent = sectionContent.replace(/\*\*/g, ''); // Remove bold

                    content += `${'='.repeat(60)}\n`;
                    content += `${section.title}\n`;
                    content += `${'='.repeat(60)}\n`;
                    content += `${sectionContent}\n\n`;
                }
            });

            content += `${'-'.repeat(60)}\n`;
            content += `Powered by Heimatverein Vorchdorf\n`;
            content += `https://heimatverein-vorchdorf.at\n`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Konservierung_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function saveAsPDF() {
            if (!currentAnalysis) return;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;
            let yPosition = margin;

            // --- HEADER ---
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(33, 33, 33);
            pdf.text('KONSERVIERUNGS-ANALYSE', margin, yPosition);
            yPosition += 8;

            // Metadata
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(100, 100, 100);
            const timestamp = new Date().toLocaleString('de-AT');
            pdf.text(`Zeitpunkt: ${timestamp}`, margin, yPosition);
            yPosition += 6;

            // Extract Title
            const priorityMatch = currentAnalysis.match(/###SECTION_START: PRIORITY###([\s\S]*?)###SECTION_END: PRIORITY###/);
            const title = priorityMatch ? (priorityMatch[1].match(/TITEL:\s*(.+)/i)?.[1]?.trim() || 'Unbekanntes Objekt') : 'Unbekanntes Objekt';

            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(0, 0, 0);
            pdf.text(title, margin, yPosition);
            yPosition += 15;

            // --- BILDER ---
            const imageCount = images.filter(img => img !== null).length;
            if (imageCount > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(0, 0, 0);
                pdf.text('DOKUMENTATION:', margin, yPosition);
                yPosition += 8;

                // Helper to get image dimensions
                const getImageDimensions = (dataUrl) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => resolve({ width: img.width, height: img.height });
                        img.src = dataUrl;
                    });
                };

                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        // Get dimensions
                        const dims = await getImageDimensions(images[i]);
                        const aspectRatio = dims.width / dims.height;

                        // Calculate dimensions fitting into max width/height
                        const maxImgHeight = 100; // Max height in mm

                        let imgWidth = contentWidth;
                        let imgHeight = imgWidth / aspectRatio;

                        if (imgHeight > maxImgHeight) {
                            imgHeight = maxImgHeight;
                            imgWidth = imgHeight * aspectRatio;
                        }

                        // Check Page Break
                        if (yPosition + imgHeight + 20 > pageHeight) {
                            pdf.addPage();
                            yPosition = margin;
                        }

                        // Center image
                        const xOffset = margin + (contentWidth - imgWidth) / 2;

                        // Bild einf√ºgen
                        pdf.addImage(images[i], 'JPEG', xOffset, yPosition, imgWidth, imgHeight);

                        yPosition += imgHeight + 5;

                        // Context Text
                        if (contextTexts[i]) {
                            // Check if text fits on page, else break (rough estimation)
                            if (yPosition > pageHeight - 20) {
                                pdf.addPage();
                                yPosition = margin;
                            }

                            pdf.setFontSize(9);
                            pdf.setFont(undefined, 'italic');
                            pdf.setTextColor(80, 80, 80);
                            const contextLines = pdf.splitTextToSize(`Bild ${i + 1}: ${contextTexts[i]}`, contentWidth);
                            pdf.text(contextLines, margin, yPosition);
                            yPosition += contextLines.length * 4 + 10;
                        } else {
                            yPosition += 5;
                        }
                    }
                }
            }

            // --- ANALYSE SECTIONS ---
            // Page Break for Analysis Start
            pdf.addPage();
            yPosition = margin;

            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(0, 0, 0);
            pdf.text('ERGEBNISSE:', margin, yPosition);
            yPosition += 10;

            // Define Sections and Colors (matching CSS)
            const sections = [
                { id: 'PRIORITY', title: 'ZUSAMMENFASSUNG & PRIORIT√ÑT', icon: '‚ö°', color: [234, 88, 12] }, // Orange-600 like
                { id: '1', title: 'MATERIAL-IDENTIFIKATION', icon: 'üî¨', color: [37, 99, 235] }, // Blue-600
                { id: '2', title: 'ZUSTANDSANALYSE', icon: 'üìã', color: [147, 51, 234] }, // Purple-600
                { id: '3', title: 'RISIKOBEWERTUNG', icon: '‚ö†Ô∏è', color: [220, 38, 38] }, // Red-600
                { id: '4', title: 'KONSERVIERUNGSKONZEPT', icon: 'üõ°Ô∏è', color: [22, 163, 74] }, // Green-600
                { id: '5', title: 'HANDLUNGSEMPFEHLUNGEN', icon: 'üéØ', color: [234, 88, 12] }, // Orange-600
                { id: '6', title: 'QUELLEN & LITERATUR', icon: 'üìö', color: [217, 119, 6] }  // Amber-600
            ];

            // Helper to parse section content
            const getSectionContent = (id) => {
                const regex = new RegExp(`###SECTION_START: ${id}###([\\s\\S]*?)###SECTION_END: ${id}###`);
                const match = currentAnalysis.match(regex);
                return match ? match[1].trim() : null;
            };

            sections.forEach(section => {
                let content = getSectionContent(section.id);
                if (!content) return;

                // Clean content
                content = content.replace(/\*\*/g, ''); // Remove bold markers

                // Special handling for Priority to make it readable
                if (section.id === 'PRIORITY') {
                    // Format Priority nicely
                    const lines = content.split('\n').filter(l => l.trim() !== '');
                    content = lines.join('\n');
                }

                // Check space for Header + at least 3 lines of text
                if (yPosition > pageHeight - 40) {
                    pdf.addPage();
                    yPosition = margin;
                }

                // --- DRAW HEADER BLOCK ---
                pdf.setFillColor(...section.color);
                pdf.rect(margin, yPosition, contentWidth, 10, 'F');

                // Header Text
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                // Note: jsPDF doesn't support emoji well in standard fonts. 
                // We will use just the title for reliability, or try to map simple ones.
                // For safety/compatibility, we stick to text title in the block.
                pdf.text(section.title, margin + 2, yPosition + 7);

                yPosition += 15;

                // --- DRAW BODY CONTENT ---
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');

                const splitLines = pdf.splitTextToSize(content, contentWidth);

                for (let i = 0; i < splitLines.length; i++) {
                    if (yPosition > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }
                    pdf.text(splitLines[i], margin, yPosition);
                    yPosition += 5;
                }

                yPosition += 5; // Spacing after section
            });

            // Footer
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(8);
                pdf.setTextColor(150, 150, 150);
                pdf.text(`Seite ${i} von ${pageCount} | Powered by Heimatverein Vorchdorf`, margin, pageHeight - 10);
            }

            pdf.save(`Konservierung_${Date.now()}.pdf`);
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.textContent = message;
            errorSection.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }
    </script>
</body>

</html>