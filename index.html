<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konservieren - Artefakt Analyse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --museum-gold: #d97706;
            --museum-charcoal: #1f2937;
            --museum-paper: #fef3c7;
            --museum-stone: #e5e7eb;
            --gold-gradient-start: #b45309;
            --gold-gradient-end: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--museum-paper);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: var(--museum-charcoal);
        }

        /* Dark Header wie WasBinIch */
        .header {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: var(--museum-gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title {
            font-family: 'Cinzel', serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.1em;
        }

        .header-subtitle {
            font-size: 11px;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.7);
        }

        .header-badge {
            background: rgba(217, 119, 6, 0.2);
            border: 1px solid var(--museum-gold);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--museum-gold);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 40px;
        }

        /* Hero Section wie WasBinIch */
        .hero {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 60px;
        }

        .hero-badge {
            display: inline-block;
            padding: 8px 16px;
            border: 2px solid rgba(217, 119, 6, 0.3);
            border-radius: 50px;
            background: rgba(217, 119, 6, 0.05);
            margin-bottom: 20px;
        }

        .hero-badge-text {
            color: var(--museum-gold);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }

        .hero-title {
            font-family: 'Cinzel', serif;
            font-size: 56px;
            line-height: 1.2;
            margin-bottom: 20px;
            font-weight: 400;
            color: var(--museum-charcoal);
        }

        .hero-title-emphasis {
            display: block;
            font-weight: 700;
            font-style: italic;
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
        }

        .hero-description {
            font-size: 16px;
            line-height: 1.6;
            color: #6b7280;
            max-width: 600px;
            margin: 0 auto;
        }

        .api-key-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .api-key-section.hidden {
            display: none;
        }

        .api-key-section h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .api-key-section p {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .api-key-section a {
            color: #667eea;
            text-decoration: none;
        }

        .api-key-section a:hover {
            text-decoration: underline;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .api-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 32px;
            border: 1px solid var(--museum-charcoal);
            border-radius: 2px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.4);
            background: linear-gradient(135deg, #a3470a, #f59e0b);
        }

        .btn-secondary {
            background: transparent;
            color: var(--museum-charcoal);
            border: 1px solid var(--museum-stone);
            padding: 12px 24px;
            font-size: 11px;
        }

        .btn-secondary:hover {
            border-color: var(--museum-gold);
            background: white;
            color: var(--museum-gold);
        }

        .usage-section {
            margin-bottom: 30px;
        }

        .usage-section.hidden {
            display: none;
        }

        .usage-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .usage-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .usage-option {
            padding: 20px;
            border: 2px solid var(--museum-stone);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            background: white;
        }

        .usage-option:hover {
            border-color: var(--museum-gold);
            background: rgba(217, 119, 6, 0.05);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.15);
            transform: translateY(-4px);
        }

        .usage-option.selected {
            border-color: var(--museum-gold);
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05));
            border-width: 2px;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.2);
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-section.hidden {
            display: none;
        }

        /* Modern Upload Area wie WasBinIch */
        .upload-area {
            border: 2px dashed rgba(217, 119, 6, 0.4);
            border-radius: 16px;
            padding: 48px 32px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s;
            margin-bottom: 40px;
        }

        .upload-area:hover {
            border-color: var(--museum-gold);
            background: rgba(217, 119, 6, 0.02);
        }

        .upload-icon-container {
            width: 80px;
            height: 80px;
            background: rgba(217, 119, 6, 0.1);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .upload-icon {
            font-size: 40px;
        }

        .upload-title {
            font-family: 'Cinzel', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--museum-charcoal);
            margin-bottom: 12px;
        }

        .upload-description {
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 15px;
            line-height: 1.6;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .upload-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .upload-button-gallery {
            background: var(--museum-charcoal);
            color: white;
            border: none;
        }

        .upload-button-gallery:hover {
            background: #111827;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .upload-button-camera {
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            color: white;
            border: none;
        }

        .upload-button-camera:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(217, 119, 6, 0.3);
        }

        .upload-hint {
            font-size: 13px;
            color: #9ca3af;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .image-slot {
            border: 2px dashed var(--museum-stone);
            border-radius: 2px;
            padding: 15px;
            text-align: center;
            position: relative;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            background: rgba(249, 248, 246, 0.5);
        }

        .image-slot.has-image {
            border-style: solid;
            border-color: var(--museum-gold);
            background: white;
            box-shadow: 0 4px 16px rgba(217, 119, 6, 0.2);
        }

        .image-preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
        }

        .image-preview-small {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 5px;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .remove-image:hover {
            background: #c82333;
        }

        .image-context {
            margin-top: 10px;
        }

        .image-context textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .image-context textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .image-context label {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .upload-btn-small {
            padding: 10px 20px;
            font-size: 14px;
            min-height: auto;
        }

        .upload-btn {
            position: relative;
            overflow: hidden;
        }

        .upload-btn input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .analyze-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--gold-gradient-start), var(--gold-gradient-end));
            color: white;
            padding: 20px;
            font-size: 14px;
            min-height: auto;
            border: none;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(217, 119, 6, 0.4);
            background: linear-gradient(135deg, #a3470a, #f59e0b);
        }

        .analyze-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            margin-bottom: 30px;
        }

        .result-section.hidden {
            display: none;
        }

        .result-box {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 2px solid var(--museum-stone);
            margin-bottom: 20px;
            white-space: pre-wrap;
            line-height: 1.8;
            color: var(--museum-charcoal);
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--museum-charcoal);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.1em;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid var(--museum-stone);
            border-top: 3px solid var(--museum-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .error.hidden {
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid var(--museum-stone);
            color: var(--museum-gold);
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .footer a {
            color: var(--museum-gold);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: var(--museum-charcoal);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .usage-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Dark Header wie WasBinIch -->
    <header class="header">
        <div class="header-content">
            <div class="header-logo">
                <div class="header-icon">üèõÔ∏è</div>
                <div>
                    <div class="header-title">KONSERVIEREN <span
                            style="font-size: 12px; opacity: 0.7; font-weight: 400;">v2.6</span></div>
                    <div class="header-subtitle">Artefakt-Analyse f√ºr Museum & Archiv</div>
                </div>
            </div>
            <div class="header-badge">
                ‚ú® KI-Powered
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section wie WasBinIch -->
        <div class="hero" id="heroSection">
            <div class="hero-badge">
                <span class="hero-badge-text">KI-Powered Konservierungs-Analyse</span>
            </div>
            <h1 class="hero-title">
                Jedes Artefakt
                <span class="hero-title-emphasis">braucht Pflege</span>
            </h1>
            <p class="hero-description">
                Lade Bilder deines Artefakts hoch und erhalte eine detaillierte Konservierungsanalyse ‚Äì
                wissenschaftlich fundiert und praxisnah f√ºr Museums- und Archivbest√§nde.
            </p>
        </div>

        <!-- API Key Eingabe -->
        <div id="apiKeySection" class="api-key-section">
            <h3>üîë Google Gemini API Key eingeben</h3>
            <p>
                Du ben√∂tigst einen Google Gemini API Key (kostenlos!).<br>
                Hole dir deinen Key auf <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI
                    Studio</a>.<br>
                Kostenlos: 15 Anfragen pro Minute, 1500 pro Tag.
            </p>
            <div class="api-input-group">
                <input type="password" id="apiKeyInput" placeholder="AIzaSy..." />
                <button class="btn btn-primary" onclick="saveApiKey()">Speichern</button>
            </div>
        </div>

        <!-- Fehleranzeige -->
        <div id="errorSection" class="error hidden"></div>

        <!-- Verwendungszweck -->
        <div id="usageSection" class="usage-section hidden">
            <h3>üìã Verwendungszweck des Artefakts</h3>
            <div class="usage-options">
                <div class="usage-option" onclick="selectUsage('exhibition')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üñºÔ∏è</div>
                    <strong>Dauerausstellung</strong>
                </div>
                <div class="usage-option" onclick="selectUsage('temporary')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üé®</div>
                    <strong>Wechselausstellung</strong>
                </div>
                <div class="usage-option" onclick="selectUsage('storage')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üì¶</div>
                    <strong>Langzeitlagerung</strong>
                </div>
                <div class="usage-option" onclick="selectUsage('transport')">
                    <div style="font-size: 32px; margin-bottom: 10px;">üöö</div>
                    <strong>Transport</strong>
                </div>
            </div>
        </div>

        <!-- Upload Bereich -->
        <div id="uploadSection" class="upload-section hidden">
            <!-- Modern Upload Area wie WasBinIch -->
            <div class="upload-area">
                <div class="upload-icon-container">
                    <span class="upload-icon">üì§</span>
                </div>
                <h2 class="upload-title">Artefakt hochladen</h2>
                <p class="upload-description">
                    Lade 1-4 Bilder deines Artefakts hoch oder mache ein Foto. Mehrere Perspektiven helfen bei der
                    Analyse.
                </p>

                <!-- Upload Buttons wie WasBinIch -->
                <div class="upload-buttons">
                    <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;"
                        onchange="handleMultiImageUpload(event)">
                    <button class="upload-button upload-button-gallery"
                        onclick="document.getElementById('galleryInput').click()">
                        <span>üñºÔ∏è</span>
                        <span>Galerie</span>
                    </button>

                    <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple
                        style="display: none;" onchange="handleMultiImageUpload(event)">
                    <button class="upload-button upload-button-camera"
                        onclick="document.getElementById('cameraInput').click()">
                        <span>üì∑</span>
                        <span>Foto aufnehmen</span>
                    </button>
                </div>

                <p class="upload-hint">
                    üí° Mehrere Perspektiven helfen bei der Identifizierung
                </p>
            </div>

            <div class="images-grid" id="imagesGrid">
                <div class="image-slot" id="slot1">
                    <div class="image-preview-container" id="preview1"></div>
                    <div class="upload-btn">
                        <label for="imageInput1" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 1 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput1" accept="image/*" capture="environment"
                            onchange="handleImageUpload(1, event)">
                    </div>
                    <div class="image-context" id="context1" style="display: none;">
                        <label>Kontext-Information zu Bild 1:</label>
                        <textarea id="contextText1"
                            placeholder="z.B. Gesamtansicht, lagert seit 10 Jahren bei 60% Luftfeuchtigkeit, Temperatur 18¬∞C..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot2">
                    <div class="image-preview-container" id="preview2"></div>
                    <div class="upload-btn">
                        <label for="imageInput2" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 2 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput2" accept="image/*" capture="environment"
                            onchange="handleImageUpload(2, event)">
                    </div>
                    <div class="image-context" id="context2" style="display: none;">
                        <label>Kontext-Information zu Bild 2:</label>
                        <textarea id="contextText2"
                            placeholder="z.B. Detailaufnahme eines Schadens, Verf√§rbung, Riss..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot3">
                    <div class="image-preview-container" id="preview3"></div>
                    <div class="upload-btn">
                        <label for="imageInput3" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 3 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput3" accept="image/*" capture="environment"
                            onchange="handleImageUpload(3, event)">
                    </div>
                    <div class="image-context" id="context3" style="display: none;">
                        <label>Kontext-Information zu Bild 3:</label>
                        <textarea id="contextText3"
                            placeholder="z.B. R√ºckseite, Unterseite, Materialdetails..."></textarea>
                    </div>
                </div>

                <div class="image-slot" id="slot4">
                    <div class="image-preview-container" id="preview4"></div>
                    <div class="upload-btn">
                        <label for="imageInput4" class="btn btn-primary upload-btn-small">
                            üì∑ Bild 4 hinzuf√ºgen
                        </label>
                        <input type="file" id="imageInput4" accept="image/*" capture="environment"
                            onchange="handleImageUpload(4, event)">
                    </div>
                    <div class="image-context" id="context4" style="display: none;">
                        <label>Kontext-Information zu Bild 4:</label>
                        <textarea id="contextText4"
                            placeholder="z.B. Nahaufnahme von Materialstruktur, Beschriftung..."></textarea>
                    </div>
                </div>
            </div>

            <button class="btn analyze-btn" id="analyzeBtn" onclick="analyzeArtifact()" disabled>üîç
                Konservierungsanalyse starten</button>
        </div>

        <!-- Lade-Animation -->
        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <p>Analysiere Artefakt f√ºr Konservierung...</p>
        </div>

        <!-- Ergebnis -->
        <div id="resultSection" class="result-section hidden">
            <h3 style="margin-bottom: 15px; color: #333;">Konservierungs-Analyse:</h3>
            <div id="resultBox" class="result-box"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="newAnalysis()">üîÑ Neue Analyse</button>
                <button class="btn btn-secondary" onclick="saveAsPDF()">üìÑ Als PDF speichern</button>
                <button class="btn btn-secondary" onclick="saveAsText()">üíæ Als Text speichern</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            Powered by <strong><a href="https://heimatverein-vorchdorf.at" target="_blank">Heimatverein
                    Vorchdorf</a></strong>
        </div>
    </div>

    <!-- jsPDF Bibliothek f√ºr PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        let images = [null, null, null, null];
        let contextTexts = ['', '', '', ''];
        let selectedUsage = null;
        let currentAnalysis = null;
        let apiKey = 'AIzaSyBudkecvmZX9cRyXRaPw16Fct2MbGDBQog'; // Shared domain-restricted key (fischervorchdorf.github.io/*)

        // Automatically show usage selection on load
        window.onload = function () {
            // Load saved API key if available
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKeyInput').value = savedKey;
            }

            // Show usage selection directly, keep hero section visible
            document.getElementById('usageSection').classList.remove('hidden');
            document.getElementById('apiKeySection').classList.add('hidden'); // Ensure API key section is hidden
        };


        function selectUsage(usage) {
            selectedUsage = usage;

            // Alle Optionen zur√ºcksetzen
            document.querySelectorAll('.usage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Ausgew√§hlte Option markieren
            event.target.closest('.usage-option').classList.add('selected');

            // Upload-Bereich anzeigen
            document.getElementById('uploadSection').classList.remove('hidden');
        }

        function handleImageUpload(slotNumber, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Maximale Gr√∂√üe: 1600px
                    const maxSize = 1600;
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    images[slotNumber - 1] = canvas.toDataURL('image/jpeg', 0.8);

                    // Vorschau anzeigen
                    const previewContainer = document.getElementById('preview' + slotNumber);
                    previewContainer.innerHTML = `
                        <img src="${images[slotNumber - 1]}" class="image-preview-small">
                        <button class="remove-image" onclick="removeImage(${slotNumber})">√ó</button>
                    `;

                    // Kontext-Textfeld anzeigen
                    document.getElementById('context' + slotNumber).style.display = 'block';
                    document.getElementById('slot' + slotNumber).classList.add('has-image');

                    // Analyse-Button aktivieren wenn mindestens ein Bild vorhanden
                    updateAnalyzeButton();
                    hideError();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleMultiImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            // Max 4 images
            const maxImages = 4;
            const filesToProcess = Array.from(files).slice(0, maxImages);

            // Process each file and assign to next available slot
            filesToProcess.forEach((file, index) => {
                // Find next empty slot
                let slotNumber = index + 1;

                // If slot already has image, find next empty one
                while (slotNumber <= 4 && images[slotNumber - 1] !== null) {
                    slotNumber++;
                }

                if (slotNumber > 4) return; // No more slots available

                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Maximale Gr√∂√üe: 1600px
                        const maxSize = 1600;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        images[slotNumber - 1] = canvas.toDataURL('image/jpeg', 0.8);

                        // Vorschau anzeigen
                        const previewContainer = document.getElementById('preview' + slotNumber);
                        previewContainer.innerHTML = `
                            <img src="${images[slotNumber - 1]}" class="image-preview-small">
                            <button class="remove-image" onclick="removeImage(${slotNumber})">√ó</button>
                        `;

                        // Kontext-Textfeld anzeigen
                        document.getElementById('context' + slotNumber).style.display = 'block';
                        document.getElementById('slot' + slotNumber).classList.add('has-image');

                        // Analyse-Button aktivieren
                        updateAnalyzeButton();
                        hideError();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // Clear the input so the same files can be selected again if needed
            event.target.value = '';
        }

        function removeImage(slotNumber) {
            images[slotNumber - 1] = null;
            contextTexts[slotNumber - 1] = '';

            document.getElementById('preview' + slotNumber).innerHTML = '';
            document.getElementById('context' + slotNumber).style.display = 'none';
            document.getElementById('contextText' + slotNumber).value = '';
            document.getElementById('imageInput' + slotNumber).value = '';
            document.getElementById('slot' + slotNumber).classList.remove('has-image');

            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const hasImages = images.some(img => img !== null);
            document.getElementById('analyzeBtn').disabled = !hasImages;
        }

        async function analyzeArtifact() {
            // Kontext-Texte sammeln
            for (let i = 0; i < 4; i++) {
                const textarea = document.getElementById('contextText' + (i + 1));
                if (textarea) {
                    contextTexts[i] = textarea.value.trim();
                }
            }

            // UI Updates
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            hideError();

            try {
                // Prompt erstellen
                let prompt = buildConservationPrompt();

                // Contents f√ºr Gemini API vorbereiten
                let parts = [{ text: prompt }];

                // Bilder hinzuf√ºgen
                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        const base64Data = images[i].split(',')[1];
                        parts.push({
                            inline_data: {
                                mime_type: 'image/jpeg',
                                data: base64Data
                            }
                        });

                        if (contextTexts[i]) {
                            parts.push({
                                text: `Kontext-Information zu Bild ${i + 1}: ${contextTexts[i]}`
                            });
                        }
                    }
                }

                // Anfrage an Google Gemini
                // Using gemini-2.5-flash (same as WasBinIch app - tested and working)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API Fehler (Status ${response.status})`);
                }

                const data = await response.json();
                currentAnalysis = data.candidates[0].content.parts[0].text;

                // Ergebnis anzeigen
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultBox').textContent = currentAnalysis;
                document.getElementById('resultSection').classList.remove('hidden');

            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');

                let errorMessage = 'Fehler bei der Analyse: ' + error.message;

                if (error.message.includes('401') || error.message.includes('403') || error.message.includes('API_KEY')) {
                    errorMessage = 'Authentifizierungsfehler: Der API-Key ist ung√ºltig.\n\nBitte √ºberpr√ºfe deinen Google Gemini API-Key.';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Zu viele Anfragen: Bitte warte einen Moment.';
                } else if (error.message.includes('500') || error.message.includes('503')) {
                    errorMessage = 'Server-Fehler: Bitte versuche es sp√§ter erneut.';
                }

                showError(errorMessage);
            }
        }

        function buildConservationPrompt() {
            const usageTexts = {
                'exhibition': 'Dauerausstellung (Artefakt wird dauerhaft ausgestellt und ist Licht, Besuchern und Umwelteinfl√ºssen ausgesetzt)',
                'temporary': 'Wechselausstellung (Tempor√§re Ausstellung mit Transport und wechselnden Bedingungen)',
                'storage': 'Langzeitlagerung im Depot (Optimale Konservierung ohne Besucherverkehr)',
                'transport': 'Transport (Artefakt muss sicher transportiert werden)'
            };

            const usage = selectedUsage ? usageTexts[selectedUsage] : 'Nicht angegeben';

            return `Du bist ein wissenschaftlicher Experte f√ºr Konservierung und Restaurierung von Museumsobjekten (Conservator-Restorer).
Analysiere das/die hochgeladene(n) Bild(er) eines Artefakts streng wissenschaftlich und detailliert.
Deine Aussagen m√ºssen valide, fachlich korrekt und √ºberpr√ºfbar sein.

VERWENDUNGSZWECK: ${usage}

Bitte erstelle ein professionelles Konservierungsgutachten mit folgenden Punkten:

1. WISSENSCHAFTLICHE MATERIAL-IDENTIFIKATION:
   - Pr√§zise Bestimmung der Materialien (z.B. nicht nur "Holz", sondern "Nadelholz, vermutlich Fichte/Tanne" wenn erkennbar)
   - Identifikation von Herstellungstechniken
   - Materialkombinationen und deren Wechselwirkungen

2. DETAILLIERTE ZUSTANDSANALYSE (Condition Report):
   - Systematische Erfassung aller Sch√§den (Kartierung)
   - Differenzierung zwischen historischen Sch√§den (Patina) und aktiven Sch√§den
   - Ursachenanalyse f√ºr jeden Schaden (z.B. "Rissbildung durch hygroskopische Spannungen")

3. RISIKOBEWERTUNG (Risk Assessment):
   - Akute Gefahren f√ºr die Substanz
   - Langfristige Degradationsprozesse
   - Risiken durch den geplanten Verwendungszweck (${usage})

4. KONSERVIERUNGSKONZEPT (Ma√ünahmen):
   - Pr√§ventive Konservierung (Klima, Licht, Lagerung) mit KONKRETEN WERTEN (Lux, ¬µW/lm, ¬∞C, rF%)
   - Konservatorische Sicherungsma√ünahmen (nur reversible Eingriffe)
   - Restaurierungsvorschl√§ge (falls √§sthetisch oder strukturell notwendig)
   - Empfohlene Materialien f√ºr Lagerung/Verpackung (z.B. "s√§urefreies Seidenpapier nach ISO 9706")

5. QUELLENVERZEICHNIS & LITERATUR:
   - Liste am Ende UNBEDINGT die verwendeten wissenschaftlichen Quellen, Normen und Richtlinien auf.
   - Zitiere relevante Standards (DIN, EN, ISO) oder Fachliteratur (z.B. ICOM-CC, IIC).
   - Gib Links zu vertrauensw√ºrdigen Online-Ressourcen an (z.B. hornemann-institut.de, canada.ca/conservation, etc.).

WICHTIG:
- Arbeite streng wissenschaftlich.
- Unterscheide klar zwischen Fakten (sichtbar) und Vermutungen.
- Verwende die korrekte Fachterminologie.
- Gib am Ende IMMER eine Liste der verwendeten Quellen und Links an.

Antworte auf Deutsch in einem strukturierten, gut lesbaren Format.`;
        }

        function newAnalysis() {
            // Reset
            images = [null, null, null, null];
            contextTexts = ['', '', '', ''];
            selectedUsage = null;
            currentAnalysis = null;

            // UI Reset
            for (let i = 1; i <= 4; i++) {
                document.getElementById('preview' + i).innerHTML = '';
                document.getElementById('context' + i).style.display = 'none';
                document.getElementById('contextText' + i).value = '';
                document.getElementById('imageInput' + i).value = '';
                document.getElementById('slot' + i).classList.remove('has-image');
            }

            document.querySelectorAll('.usage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('usageSection').classList.remove('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            hideError();
        }

        function saveAsText() {
            if (!currentAnalysis) return;

            const timestamp = new Date().toLocaleString('de-AT');
            const usageTexts = {
                'exhibition': 'Dauerausstellung',
                'temporary': 'Wechselausstellung',
                'storage': 'Langzeitlagerung',
                'transport': 'Transport'
            };

            let content = `KONSERVIERUNGS-ANALYSE\n${'='.repeat(70)}\n`;
            content += `Zeitpunkt: ${timestamp}\n`;
            content += `Verwendungszweck: ${usageTexts[selectedUsage] || 'Nicht angegeben'}\n`;
            content += `${'='.repeat(70)}\n\n`;

            // Kontext-Informationen
            let hasContext = false;
            for (let i = 0; i < 4; i++) {
                if (images[i] && contextTexts[i]) {
                    if (!hasContext) {
                        content += `KONTEXT-INFORMATIONEN:\n${'-'.repeat(70)}\n`;
                        hasContext = true;
                    }
                    content += `Bild ${i + 1}: ${contextTexts[i]}\n`;
                }
            }
            if (hasContext) content += `\n`;

            content += `ANALYSE:\n${'-'.repeat(70)}\n${currentAnalysis}\n\n`;
            content += `${'='.repeat(70)}\n`;
            content += `Powered by Heimatverein Vorchdorf\n`;
            content += `https://heimatverein-vorchdorf.at\n`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Konservierung_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function saveAsPDF() {
            if (!currentAnalysis) return;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;
            let yPosition = margin;

            // Titel
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('KONSERVIERUNGS-ANALYSE', margin, yPosition);
            yPosition += 10;

            // Metadata
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const timestamp = new Date().toLocaleString('de-AT');
            pdf.text(`Zeitpunkt: ${timestamp}`, margin, yPosition);
            yPosition += 6;

            const usageTexts = {
                'exhibition': 'Dauerausstellung',
                'temporary': 'Wechselausstellung',
                'storage': 'Langzeitlagerung',
                'transport': 'Transport'
            };
            pdf.text(`Verwendungszweck: ${usageTexts[selectedUsage] || 'Nicht angegeben'}`, margin, yPosition);
            yPosition += 10;

            // Bilder hinzuf√ºgen
            const imageCount = images.filter(img => img !== null).length;
            if (imageCount > 0) {
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('BILDER:', margin, yPosition);
                yPosition += 8;

                for (let i = 0; i < images.length; i++) {
                    if (images[i]) {
                        // Neue Seite wenn n√∂tig
                        if (yPosition > pageHeight - 80) {
                            pdf.addPage();
                            yPosition = margin;
                        }

                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`Bild ${i + 1}:`, margin, yPosition);
                        yPosition += 6;

                        // Kontext-Info
                        if (contextTexts[i]) {
                            pdf.setFont(undefined, 'italic');
                            const contextLines = pdf.splitTextToSize(`Kontext: ${contextTexts[i]}`, contentWidth);
                            pdf.text(contextLines, margin, yPosition);
                            yPosition += contextLines.length * 5 + 4;
                        }

                        // Bild einf√ºgen
                        const imgWidth = contentWidth;
                        const imgHeight = 60;
                        pdf.addImage(images[i], 'JPEG', margin, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 10;
                    }
                }
            }

            // Neue Seite f√ºr Analyse
            pdf.addPage();
            yPosition = margin;

            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('KONSERVIERUNGS-ANALYSE:', margin, yPosition);
            yPosition += 8;

            // Analyse-Text
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            const lines = pdf.splitTextToSize(currentAnalysis, contentWidth);

            for (let i = 0; i < lines.length; i++) {
                if (yPosition > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                }
                pdf.text(lines[i], margin, yPosition);
                yPosition += 5;
            }

            // Footer auf letzter Seite
            pdf.setFontSize(8);
            pdf.setFont(undefined, 'italic');
            pdf.text('Powered by Heimatverein Vorchdorf', margin, pageHeight - 10);

            // PDF speichern
            pdf.save(`Konservierung_${Date.now()}.pdf`);
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.textContent = message;
            errorSection.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }
    </script>
</body>

</html>